# Offboard Mode 

---

### Start the PX4-Gazebo Simulation 

Spawn 4 drones in one Gazebo instance

> **Note:** Run this command in each terminal to avoid CPU/GPU overload:
```bash
export PX4_SIM_SPEED_FACTOR=0.4
```

Terminal 1:

```bash
export PX4_SIM_SPEED_FACTOR=0.4
cd ~/ctuav_gazebo-research/PX4-Autopilot/
PX4_SYS_AUTOSTART=4001 PX4_GZ_MODEL_POSE="-4,4,0" PX4_SIM_MODEL=gz_x500 ./build/px4_sitl_default/bin/px4 -i 1
```

Terminal 2:

```bash
export PX4_SIM_SPEED_FACTOR=0.4
cd ~/ctuav_gazebo-research/PX4-Autopilot/
PX4_GZ_STANDALONE=1 PX4_SYS_AUTOSTART=4001 PX4_GZ_MODEL_POSE="4,4,0" PX4_SIM_MODEL=gz_x500 ./build/px4_sitl_default/bin/px4 -i 2
```

Terminal 3:

```bash
export PX4_SIM_SPEED_FACTOR=0.4
cd ~/ctuav_gazebo-research/PX4-Autopilot/
PX4_GZ_STANDALONE=1 PX4_SYS_AUTOSTART=4001 PX4_GZ_MODEL_POSE="-4,-4,0" PX4_SIM_MODEL=gz_x500 ./build/px4_sitl_default/bin/px4 -i 3
```

Terminal 4:

```bash
export PX4_SIM_SPEED_FACTOR=0.4
cd ~/ctuav_gazebo-research/PX4-Autopilot/
PX4_GZ_STANDALONE=1 PX4_SYS_AUTOSTART=4001 PX4_GZ_MODEL_POSE="4,-4,0" PX4_SIM_MODEL=gz_x500 ./build/px4_sitl_default/bin/px4 -i 4
```


### Start QGroundControl:

```bash
cd ~/ctuav_gazebo-research/Custom_QGC/qgroundcontrol
./build/Debug/QGroundControl
```

### Start the agent  
You only need one agent for all vehicles (it will handle multiple clients over UDP).


```bash
MicroXRCEAgent udp4 -p 8888
```

> **Note:** Wait until all clients finish creating all necessary topics.

### Launch MAVROS

```bash
source install/setup.bash
ros2 launch mavros multi_uas.launch
```

## Launch offboard_control node for each drone

### a. Hover 5m above the assigned position:

> **Note:** This node does not need to activate MAVROS.

Terminal 1:

```bash
ros2 run px4_ros_com offboard_multi --ros-args -p ns:=/px4_1 -p target_system:=2
```

Terminal 2:

```bash
ros2 run px4_ros_com offboard_multi --ros-args -p ns:=/px4_2 -p target_system:=3
```

Terminal 3:

```bash
ros2 run px4_ros_com offboard_multi --ros-args -p ns:=/px4_3 -p target_system:=4
```

Terminal 4:

```bash
ros2 run px4_ros_com offboard_multi --ros-args -p ns:=/px4_4 -p target_system:=5
```



<!-- colcon build --symlink-install --packages-select px4_msgs mavlink mavros_msgs px4_ros_com -->

### b. Subscribe to MARVOS GPS & IMU topics 



Terminal 1:

```bash
ros2 run px4_ros_com offboard_swarm --ros-args -p ns:=/px4_1 -p target_system:=2
```

Terminal 2:

```bash
ros2 run px4_ros_com offboard_swarm --ros-args -p ns:=/px4_2 -p target_system:=3
```

Terminal 3:

```bash
ros2 run px4_ros_com offboard_swarm --ros-args -p ns:=/px4_3 -p target_system:=4
```

Terminal 4:

```bash
ros2 run px4_ros_com offboard_swarm --ros-args -p ns:=/px4_4 -p target_system:=5
``

---

