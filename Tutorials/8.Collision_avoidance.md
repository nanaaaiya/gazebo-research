# Swarm of Drones - Collision Avoidance 
---

### Start the PX4-Gazebo Simulation 

Spawn 4 drones in one Gazebo instance

> **Note:** Run this command in each terminal to avoid CPU/GPU overload:
```bash
export PX4_SIM_SPEED_FACTOR=0.4
```

Terminal 1:

```bash
export PX4_SIM_SPEED_FACTOR=0.4
cd ~/ctuav_gazebo-research/PX4-Autopilot/
PX4_SYS_AUTOSTART=4001 PX4_GZ_MODEL_POSE="-8,8,0" PX4_SIM_MODEL=gz_x500 ./build/px4_sitl_default/bin/px4 -i 1
```

Terminal 2:

```bash
export PX4_SIM_SPEED_FACTOR=0.4
cd ~/ctuav_gazebo-research/PX4-Autopilot/
PX4_GZ_STANDALONE=1 PX4_SYS_AUTOSTART=4001 PX4_GZ_MODEL_POSE="8,8,0" PX4_SIM_MODEL=gz_x500 ./build/px4_sitl_default/bin/px4 -i 2
```

<!-- Terminal 3:

```bash
export PX4_SIM_SPEED_FACTOR=0.4
cd ~/ctuav_gazebo-research/PX4-Autopilot/
PX4_GZ_STANDALONE=1 PX4_SYS_AUTOSTART=4001 PX4_GZ_MODEL_POSE="-4,-4,0" PX4_SIM_MODEL=gz_x500 ./build/px4_sitl_default/bin/px4 -i 2
```

Terminal 4:

```bash
export PX4_SIM_SPEED_FACTOR=0.4
cd ~/ctuav_gazebo-research/PX4-Autopilot/
PX4_GZ_STANDALONE=1 PX4_SYS_AUTOSTART=4001 PX4_GZ_MODEL_POSE="4,-4,0" PX4_SIM_MODEL=gz_x500 ./build/px4_sitl_default/bin/px4 -i 3
``` -->

Note: Unfixed bugs:

ctuav@ctuav:~/ctuav_gazebo-research$ ros2 run px4_ros_com offboard_multi --ros-args -p target_system:=1 -p hover_x:=0.0 -p hover_y:=9.0 -p hover_z:=-5.0
[INFO] [1761901809.836517589] [offboard_multi]: Using namespace '' -> topics: /fmu/in/offboard_control_mode , /fmu/in/trajectory_setpoint , /fmu/in/vehicle_command
terminate called after throwing an instance of 'std::out_of_range'
  what():  basic_string::substr: __pos (which is 1) > this->size() (which is 0)
[ros2run]: Aborted




### Start QGroundControl:

```bash
cd ~/ctuav_gazebo-research/Custom_QGC/qgroundcontrol
./build/Debug/QGroundControl
```

### Start the agent  
You only need one agent for all vehicles (it will handle multiple clients over UDP).


```bash
MicroXRCEAgent udp4 -p 8888
```

> **Note:** Wait until all clients finish creating all necessary topics.

### Launch MAVROS

```bash
source install/setup.bash
ros2 launch mavros multi_uas.launch
```

## Launch offboard_control node for each drone

Note: Unfixed Bug: QGroundControl has problem with connection. Right now we cannot send commands to multiple drones via PX4. 



### Hover 5m above the assigned position:

Terminal 1:

```bash
ros2 run px4_ros_com offboard_multi --ros-args -p ns:=/px4_1 -p target_system:=2 -p hover_x:=0.0 -p hover_y:=9.0 -p hover_z:=-5.0  ```

Terminal 2:

```bash
ros2 run px4_ros_com offboard_multi --ros-args -p ns:=/px4_2 -p target_system:=3 -p hover_x:=0.0 -p hover_y:=-9.0 -p hover_z:=-5.0  ```

```

### Subscribe to MARVOS GPS of all drones + publish different trajectory when two drones are within 2 meters


```bash
ros2 run px4_ros_com collision_avoidance
```

### Receive waypoints sent by Collision Avoidance node + control drones to follow the waypoints


```bash
ros2 run px4_ros_com offboard_switcher
```

---

